// Prisma schema for Postgres deployments (e.g., Vercel)
// Mirrors the SQLite schema but with provider set to postgresql

generator client {
  provider = "prisma-client-js"
  // Keep output path consistent with existing project expectations if set in the main schema
  // If your main schema specifies a custom output, mirror it here.
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Models & Enums ---
// NOTE: Keep in sync with prisma/schema.prisma

enum SocialNetwork {
  instagram
  meta
}

enum TokenType {
  short
  long
}

model User {
  id            String           @id @default(cuid())
  email         String           @unique
  name          String?
  image         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  socialAccounts SocialAccount[]
  participations Participation[]
}

model CompanyAccount {
  id        String   @id @default(cuid())
  name      String
  ownerId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  owner   User   @relation(fields: [ownerId], references: [id])
  giveaways Giveaway[]
  socials   SocialAccount[]
}

model Giveaway {
  id           String   @id @default(cuid())
  companyId    String
  title        String
  description  String?
  startsAt     DateTime
  endsAt       DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  company       CompanyAccount @relation(fields: [companyId], references: [id])
  requirements  Requirement[]
  participations Participation[]
  selections     WinnerSelection[]
}

model Requirement {
  id          String   @id @default(cuid())
  giveawayId  String
  network     SocialNetwork
  // For Instagram comment verification we store the IG media permalink
  instagramPermalink String?
  requireComment     Boolean @default(false)
  requireLike        Boolean @default(false)

  giveaway   Giveaway @relation(fields: [giveawayId], references: [id])
}

model Participation {
  id          String   @id @default(cuid())
  giveawayId  String
  userId      String
  createdAt   DateTime @default(now())
  verifiedAt  DateTime?
  status      String   @default("pending") // pending | approved | rejected

  giveaway Giveaway @relation(fields: [giveawayId], references: [id])
  user     User     @relation(fields: [userId], references: [id])
}

model WinnerSelection {
  id           String   @id @default(cuid())
  giveawayId   String
  winnerId     String
  backupsJson  String   // JSON string of backup user IDs for portability
  createdAt    DateTime @default(now())

  giveaway Giveaway @relation(fields: [giveawayId], references: [id])
}

model SocialAccount {
  id                   String   @id // deterministic id (e.g., `${ownerId}-meta` or `${userId}-instagram`)
  userId               String?
  companyId            String?
  network              SocialNetwork
  providerUserId       String?
  handle               String?

  // Meta/Instagram tokens
  tokenType            TokenType?
  accessToken          String?
  refreshToken         String?
  accessTokenExpiresAt DateTime?

  // Meta Business fields
  pageId               String?
  instagramBusinessId  String?
  scope                String?

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  user     User?           @relation(fields: [userId], references: [id])
  company  CompanyAccount? @relation(fields: [companyId], references: [id])

  @@index([userId])
  @@index([companyId])
  @@index([network])
}
