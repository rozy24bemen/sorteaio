// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum SocialNetwork {
  instagram
  x
  tiktok
  facebook
}

enum TokenType {
  short
  long
}

enum RequirementType {
  like
  comment
  mentions
  follow
}

enum GiveawayStatus {
  draft
  active
  awaiting_winner
  finished
}

enum VerificationStatus {
  pending
  approved
  rejected
}

// Models
model User {
  id              String           @id @default(cuid())
  name            String?
  email           String?          @unique
  image           String?
  emailVerified   DateTime?
  socialAccounts  SocialAccount[]
  participations  Participation[]
  companies       CompanyAccount[] @relation("CompanyOwner")
  accounts        Account[]
  sessions        Session[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model CompanyAccount {
  id             String          @id @default(cuid())
  legalName      String
  taxId          String
  fiscalAddress  String?
  contactEmail   String
  ownerUserId    String?
  owner          User?           @relation("CompanyOwner", fields: [ownerUserId], references: [id])
  socialAccounts SocialAccount[]
  giveaways      Giveaway[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model SocialAccount {
  id               String          @id @default(cuid())
  network          SocialNetwork
  handle           String
  tokenType        TokenType?
  accessToken      String?
  refreshToken     String?
  accessTokenExpiresAt DateTime?
  providerUserId   String?        // Meta user/page/account id
  pageId           String?        // Facebook Page ID (if applicable)
  instagramBusinessId String?     // Instagram Business Account ID
  scope            String?        // Comma-separated scopes granted
  userId           String?
  user             User?           @relation(fields: [userId], references: [id])
  companyId        String?
  company          CompanyAccount? @relation(fields: [companyId], references: [id])
  createdAt        DateTime        @default(now())
}

model Giveaway {
  id              String          @id @default(cuid())
  title           String
  description     String
  imageUrl        String?
  network         SocialNetwork
  postUrl         String
  companyId       String
  company         CompanyAccount  @relation(fields: [companyId], references: [id])
  startsAt        DateTime
  endsAt          DateTime
  basesUrl        String?
  status          GiveawayStatus  @default(draft)
  requirements    Requirement[]
  participations  Participation[]
  selection       WinnerSelection?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model Requirement {
  id               String           @id @default(cuid())
  giveawayId       String
  giveaway         Giveaway         @relation(fields: [giveawayId], references: [id])
  type             RequirementType
  required         Boolean          @default(true)
  mentionsCount    Int?
  profileToFollow  String?
  order            Int?             @default(0)
  createdAt        DateTime         @default(now())
}

model Participation {
  id                  String              @id @default(cuid())
  giveawayId          String
  giveaway            Giveaway            @relation(fields: [giveawayId], references: [id])
  userId              String
  user                User                @relation(fields: [userId], references: [id])
  entries             Int                 @default(1)
  createdAt           DateTime            @default(now())
  isWinner            Boolean             @default(false)
  verificationStatus  VerificationStatus  @default(pending)
  // Relations to winner selection
  primaryOfSelection  WinnerSelection?   @relation("PrimaryParticipation")
  backupIn            WinnerBackup[]
}

model WinnerSelection {
  id                      String            @id @default(cuid())
  giveawayId              String            @unique
  giveaway                Giveaway          @relation(fields: [giveawayId], references: [id])
  executedAt              DateTime          @default(now())
  primaryParticipationId  String            @unique
  primaryParticipation    Participation     @relation("PrimaryParticipation", fields: [primaryParticipationId], references: [id])
  backups                 WinnerBackup[]
}

model WinnerBackup {
  id               String          @id @default(cuid())
  selectionId      String
  selection        WinnerSelection @relation(fields: [selectionId], references: [id])
  participationId  String
  participation    Participation   @relation(fields: [participationId], references: [id])
  order            Int             @default(0)
}

// Auth.js / NextAuth models (from official Prisma schema)
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? // token columns are provider-specific
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
